<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Project Management</title>
  <style>
    #pm-container {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      max-width: 1300px;
      margin: 20px auto;
    }
    #pm-container h1 { text-align: center; margin-bottom: 20px; color: #333; }
    #pm-form { margin-bottom: 20px; }
    #pm-form .form-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
    #pm-form input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
    #pm-form button {
      background: #007bff; color: white; padding: 10px 16px;
      border: none; border-radius: 6px; cursor: pointer;
    }
    #pm-form button:hover { background: #0056b3; }
    #pm-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    #pm-table thead { background: #007bff; color: white; cursor: pointer; }
    #pm-table th, #pm-table td {
      border: 1px solid #ddd; padding: 8px; text-align: center;
    }
    #pm-table tbody tr:nth-child(even) { background: #f9f9f9; }
    .pm-btn { padding: 5px 10px; border: none; border-radius: 6px; cursor: pointer; color: white; margin: 2px; }
    .pm-delete-btn { background: #dc3545; } .pm-delete-btn:hover { background: #a71d2a; }
    .pm-edit-btn { background: #28a745; } .pm-edit-btn:hover { background: #1e7e34; }
    .pm-move-btn { background: #6c757d; } .pm-move-btn:hover { background: #565e64; }
    #searchBar { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; }
    .status-completed { background: #d4edda !important; }
    .status-pending { background: #fff3cd !important; }
    .status-delayed { background: #f8d7da !important; }
    #export-btns { margin: 10px 0; text-align: right; }
    #export-btns button { margin-left: 5px; }
  </style>
</head>
<body>
<a href="index.html">← Home</a>
<div id="pm-container">
  <h1>Project Management Dashboard</h1>

  <!-- Search -->
  <input type="text" id="searchBar" placeholder="Search projects...">

  <!-- Form Section -->
  <form id="pm-form">
    <div class="form-row">
      <input type="text" id="pm-clientName" placeholder="Client Name" required>
      <input type="text" id="pm-buyer" placeholder="Buyer" required>
      <input type="text" id="pm-poNo" placeholder="Purchase Order No." required>
      <input type="text" id="pm-description" placeholder="Description">
      <input type="number" id="pm-quantity" placeholder="Quantity" min="1">
    </div>
    <div class="form-row">
      <input type="text" id="pm-materials" placeholder="Materials Purchase">
      <input type="text" id="pm-docs" placeholder="Documentation">
      <input type="text" id="pm-qc" placeholder="Quality Check">
      <input type="text" id="pm-delivery" placeholder="Delivery Status (Pending/Completed/Delayed)">
      <input type="text" id="pm-remarks" placeholder="Remarks">
    </div>
    <button type="submit" id="pm-submitBtn">Add Project</button>
  </form>

  <!-- Export/Import -->
  <div id="export-btns">
    <button id="export-json">Export JSON</button>
    <button id="export-csv">Export CSV</button>
    <button id="export-pdf">Export PDF</button>
    <button id="export-excel">Export Excel</button>
    <input type="file" id="import-json" accept=".json" style="display:none;">
    <button id="import-btn">Import JSON</button>
  </div>

  <!-- Table Section -->
  <table id="pm-table">
    <thead>
      <tr>
        <th data-key="clientName">Client Name</th>
        <th data-key="buyer">Buyer</th>
        <th data-key="poNo">PO No.</th>
        <th data-key="description">Description</th>
        <th data-key="quantity">Quantity</th>
        <th data-key="materials">Materials</th>
        <th data-key="docs">Documentation</th>
        <th data-key="qc">Quality Check</th>
        <th data-key="delivery">Delivery</th>
        <th data-key="remarks">Remarks</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- External libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
(function() {
  const form = document.getElementById("pm-form");
  const tableBody = document.querySelector("#pm-table tbody");
  const submitBtn = document.getElementById("pm-submitBtn");
  const searchBar = document.getElementById("searchBar");

  let projects = JSON.parse(localStorage.getItem("pm-projects")) || [];
  let editIndex = null;
  let sortOrder = {};

  renderProjects();

  // Add or update project
  form.addEventListener("submit", function(e) {
    e.preventDefault();
    const project = {
      clientName: document.getElementById("pm-clientName").value,
      buyer: document.getElementById("pm-buyer").value,
      poNo: document.getElementById("pm-poNo").value,
      description: document.getElementById("pm-description").value,
      quantity: document.getElementById("pm-quantity").value,
      materials: document.getElementById("pm-materials").value,
      docs: document.getElementById("pm-docs").value,
      qc: document.getElementById("pm-qc").value,
      delivery: document.getElementById("pm-delivery").value,
      remarks: document.getElementById("pm-remarks").value
    };

    if (editIndex === null) {
      projects.push(project);
    } else {
      projects[editIndex] = project;
      editIndex = null;
      submitBtn.textContent = "Add Project";
    }

    saveProjects();
    renderProjects();
    form.reset();
  });

  function saveProjects() {
    localStorage.setItem("pm-projects", JSON.stringify(projects));
  }

  function renderProjects() {
    tableBody.innerHTML = "";
    const filter = searchBar.value.toLowerCase();
    projects.forEach((p, index) => {
      if (Object.values(p).some(val => String(val).toLowerCase().includes(filter))) {
        const row = document.createElement("tr");

        if (p.delivery.toLowerCase() === "completed") row.classList.add("status-completed");
        else if (p.delivery.toLowerCase() === "pending") row.classList.add("status-pending");
        else if (p.delivery.toLowerCase() === "delayed") row.classList.add("status-delayed");

        row.innerHTML = `
          <td>${p.clientName}</td>
          <td>${p.buyer}</td>
          <td>${p.poNo}</td>
          <td>${p.description}</td>
          <td>${p.quantity}</td>
          <td>${p.materials}</td>
          <td>${p.docs}</td>
          <td>${p.qc}</td>
          <td>${p.delivery}</td>
          <td>${p.remarks}</td>
          <td>
            <button class="pm-btn pm-edit-btn" data-index="${index}">Edit</button>
            <button class="pm-btn pm-delete-btn" data-index="${index}">Delete</button>
            <button class="pm-btn pm-move-btn" data-move="up" data-index="${index}">↑</button>
            <button class="pm-btn pm-move-btn" data-move="down" data-index="${index}">↓</button>
          </td>
        `;
        tableBody.appendChild(row);
      }
    });

    document.querySelectorAll(".pm-edit-btn").forEach(btn => {
      btn.addEventListener("click", function() {
        editIndex = this.getAttribute("data-index");
        loadProjectIntoForm(projects[editIndex]);
        submitBtn.textContent = "Update Project";
      });
    });

    document.querySelectorAll(".pm-delete-btn").forEach(btn => {
      btn.addEventListener("click", function() {
        const i = this.getAttribute("data-index");
        if (confirm("Are you sure you want to delete this project?")) {
          projects.splice(i, 1);
          saveProjects();
          renderProjects();
        }
      });
    });

    document.querySelectorAll(".pm-move-btn").forEach(btn => {
      btn.addEventListener("click", function() {
        const i = parseInt(this.getAttribute("data-index"));
        const dir = this.getAttribute("data-move");
        if (dir === "up" && i > 0) {
          [projects[i-1], projects[i]] = [projects[i], projects[i-1]];
        } else if (dir === "down" && i < projects.length-1) {
          [projects[i+1], projects[i]] = [projects[i], projects[i+1]];
        }
        saveProjects();
        renderProjects();
      });
    });
  }

  function loadProjectIntoForm(p) {
    document.getElementById("pm-clientName").value = p.clientName;
    document.getElementById("pm-buyer").value = p.buyer;
    document.getElementById("pm-poNo").value = p.poNo;
    document.getElementById("pm-description").value = p.description;
    document.getElementById("pm-quantity").value = p.quantity;
    document.getElementById("pm-materials").value = p.materials;
    document.getElementById("pm-docs").value = p.docs;
    document.getElementById("pm-qc").value = p.qc;
    document.getElementById("pm-delivery").value = p.delivery;
    document.getElementById("pm-remarks").value = p.remarks;
  }

  searchBar.addEventListener("input", renderProjects);

  document.querySelectorAll("#pm-table thead th[data-key]").forEach(th => {
    th.addEventListener("click", function() {
      const key = this.dataset.key;
      sortOrder[key] = !sortOrder[key];
      projects.sort((a, b) => {
        let x = String(a[key]).toLowerCase();
        let y = String(b[key]).toLowerCase();
        return sortOrder[key] ? x.localeCompare(y) : y.localeCompare(x);
      });
      renderProjects();
    });
  });

  document.getElementById("export-json").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(projects, null, 2)], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "projects.json"; a.click();
  });

  document.getElementById("export-csv").addEventListener("click", () => {
    let csv = Object.keys(projects[0] || {}).join(",") + "\n";
    projects.forEach(p => { csv += Object.values(p).join(",") + "\n"; });
    const blob = new Blob([csv], {type: "text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "projects.csv"; a.click();
  });

  // Export PDF
  document.getElementById("export-pdf").addEventListener("click", () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Project Management Report", 14, 15);
    doc.autoTable({
      startY: 20,
      head: [["Client Name","Buyer","PO No.","Description","Quantity","Materials","Docs","QC","Delivery","Remarks"]],
      body: projects.map(p => [p.clientName,p.buyer,p.poNo,p.description,p.quantity,p.materials,p.docs,p.qc,p.delivery,p.remarks])
    });
    doc.save("projects.pdf");
  });

  // Export Excel
  document.getElementById("export-excel").addEventListener("click", () => {
    const worksheet = XLSX.utils.json_to_sheet(projects);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Projects");
    XLSX.writeFile(workbook, "projects.xlsx");
  });

  document.getElementById("import-btn").addEventListener("click", () => {
    document.getElementById("import-json").click();
  });
  document.getElementById("import-json").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          projects = JSON.parse(reader.result);
          saveProjects();
          renderProjects();
        } catch {
          alert("Invalid JSON file");
        }
      };
      reader.readAsText(file);
    }
  });

})();
</script>
</body>
</html>